<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ç–∞–ª–æ–≥ ‚Äî –ö–æ—Ç–æ—Ñ–∞–±—Ä–∏–∫–∞</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
</head>
<body class="app">
<header class="app-header">
    <div class="container app-header__inner">
        <a class="brand" href="{% url 'home' %}"><span class="brand-icon">üêæ</span>–ö–æ—Ç–æ—Ñ–∞–±—Ä–∏–∫–∞</a>
        <nav class="app-header__nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
            <a class="app-header__link app-header__link--active" href="{% url 'catalog' %}">–ö–∞—Ç–∞–ª–æ–≥</a>
        </nav>
        <div class="app-header__actions">
            <a class="secondary-btn" href="{% url 'builder' %}">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</a>
            <a class="ghost-btn" href="{% url 'cart' %}" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">üõí</a>
            <a class="ghost-btn" href="{% url 'profile' %}" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">üë§</a>
        </div>
    </div>
</header>

<main>
    <section class="catalog-hero">
        <div class="container catalog-hero__inner">
            <div>
                <span class="tag">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –∫–æ—Ç–∏–∫–æ–≤</span>
                <h1>–í—ã–±–∏—Ä–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Å–±–æ—Ä–∫–∏ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞</h1>
                <p class="text-muted">
                    {% if user.is_authenticated %}
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}! –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–±—Ä–∞—Ç—å –∫–æ—Ç–∏–∫–∞ –∏–∑ –¥–µ—Ç–∞–ª–µ–π –∫–æ—Ä–∑–∏–Ω—ã –∏–ª–∏ –∫—É–ø–∏—Ç—å –≥–æ—Ç–æ–≤—ã–µ –Ω–∞–±–æ—Ä—ã –∏–∑
                    –≤–∏—Ç—Ä–∏–Ω—ã. –í—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.
                    {% else %}
                    –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É –∏ –ø–æ–∫—É–ø–∫–∞–º –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.
                    {% endif %}
                </p>
                <div class="catalog-hero__actions">
                    {% if user.is_authenticated %}
                    <a class="primary-btn" href="{% url 'builder' %}">–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ—Ç–∏–∫–æ–≤</a>
                    {% else %}
                    <a class="primary-btn" href="{% url 'login' %}">–í–æ–π—Ç–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</a>
                    {% endif %}
                </div>
            </div>
            <div class="hero-cat-showcase">
                <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (—Å—Ç–∞—Ç–∏–∫–∞) -->
                <img class="cat-layer cat-body" src="{% static 'images/body-1.png' %}" alt="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¢–µ–ª–æ" />
                <img class="cat-layer cat-head" src="{% static 'images/head-1.png' %}" alt="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ì–æ–ª–æ–≤–∞" />
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container catalog-layout">
            <aside class="catalog-sidebar">
                <h2>–§–∏–ª—å—Ç—Ä—ã</h2>
                <div class="catalog-filter">
                    <h3>–ß–∞—Å—Ç–∏ –∫–æ—Ç–∏–∫–∞</h3>
                    <!-- –ó–Ω–∞—á–µ–Ω–∏—è value –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å choices –≤ models.py (head/body) -->
                    <label>
                        <input type="checkbox" name="category" value="head"> –ì–æ–ª–æ–≤—ã
                    </label>
                    <label>
                        <input type="checkbox" name="category" value="body"> –¢—É–ª–æ–≤–∏—â–∞
                    </label>
                </div>
                <div class="catalog-filter">
                    <h3>–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω—ã</h3>
                    <label>
                        <input type="checkbox" name="price" value="low"> –¥–æ 500 ‚ÇΩ
                    </label>
                    <label>
                        <input type="checkbox" name="price" value="mid"> 500‚Äì1500 ‚ÇΩ
                    </label>
                    <label>
                        <input type="checkbox" name="price" value="high"> 1500 ‚ÇΩ –∏ –≤—ã—à–µ
                    </label>
                </div>
            </aside>

            <div class="catalog-grid">
                {% for part in parts %}
                <!--
                    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞.
                    data-category –±–µ—Ä–µ—Ç—Å—è –∏–∑ part.part_type (head –∏–ª–∏ body)
                    data-price –±–µ—Ä–µ—Ç—Å—è –∏–∑ part.price
                 -->
                <article class="product-card" data-category="{{ part.part_type }}" data-price="{{ part.price|floatformat:0 }}">
                    <div class="cat-image-container">
                        <!-- –í—ã–≤–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
                        {% if part.image %}
                            <img class="cat-part-image" src="{{ part.image.url }}" alt="{{ part.name }}" />
                        {% else %}
                            <!-- –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç -->
                            <div style="width:100%; height:200px; background:#eee; display:flex; align-items:center; justify-content:center;">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
                        {% endif %}
                    </div>
                    <div class="product-card__info">
                        <h3>{{ part.name }}</h3>
                        <p>{{ part.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç" }}</p>
                        <div class="product-card__meta">
                            <span>{{ part.price }} ‚ÇΩ</span>

                            {% if user.is_authenticated %}
                                <!-- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ cart_part_ids, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–ª–∏ –∏–∑ views.py -->
                                {% if part.id in cart_part_ids %}
                                    <button class="secondary-btn" type="button" disabled style="opacity: 0.7; cursor: default;">–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ</button>
                                {% else %}
                                    <button class="secondary-btn add-to-cart-btn" type="button" data-id="{{ part.id }}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                                {% endif %}
                            {% else %}
                                <a class="secondary-btn" href="{% url 'login' %}">–í–æ–π—Ç–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</a>
                            {% endif %}
                        </div>
                    </div>
                </article>
                {% empty %}
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>–í –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</h3>
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>
</main>

<script>
    // 1. –°–∫—Ä–∏–ø—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª)
    function applyCatalogFilters() {
        const selectedCats = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(el => el.value);
        const selectedPrices = Array.from(document.querySelectorAll('input[name="price"]:checked')).map(el => el.value);
        const cards = document.querySelectorAll('.product-card');

        cards.forEach(card => {
            const category = card.dataset.category;
            const price = parseInt(card.dataset.price);

            const matchCat = selectedCats.length === 0 || selectedCats.includes(category);

            let matchPrice = false;
            if (selectedPrices.length === 0) {
                matchPrice = true;
            } else {
                selectedPrices.forEach(range => {
                    if (range === 'low' && price < 500) matchPrice = true;
                    if (range === 'mid' && price >= 500 && price <= 1500) matchPrice = true;
                    if (range === 'high' && price > 1500) matchPrice = true;
                });
            }

            if (matchCat && matchPrice) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // 2. –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É (AJAX)
    document.addEventListener('DOMContentLoaded', () => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const inputs = document.querySelectorAll('.catalog-sidebar input');
        inputs.forEach(input => {
            input.addEventListener('change', applyCatalogFilters);
        });

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–í –∫–æ—Ä–∑–∏–Ω—É"
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');

        addToCartButtons.forEach(button => {
            button.addEventListener('click', function() {
                const partId = this.dataset.id; // –ü–æ–ª—É—á–∞–µ–º ID —Ç–æ–≤–∞—Ä–∞ –∏–∑ data-id
                const btn = this; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch('{% url "add_to_cart" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' // –¢–æ–∫–µ–Ω –∑–∞—â–∏—Ç—ã Django
                    },
                    body: JSON.stringify({
                        'part_id': partId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' || data.status === 'exists') {
                        // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–∏–ª–∏ –∏–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –±—ã–ª —Ç–∞–º -> –º–µ–Ω—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
                        btn.textContent = "–£–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ";
                        btn.disabled = true;
                        btn.style.opacity = "0.7";
                        btn.style.cursor = "default";
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                });
            });
        });

        console.log("–ö–∞—Ç–∞–ª–æ–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    });
</script>
</body>
</html>